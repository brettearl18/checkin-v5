rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user's UID
    function getUserId() {
      return request.auth.uid;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(getUserId())).data.role == 'admin';
    }
    
    // Check if user has admin role (including roles array)
    function hasAdminRole() {
      let userData = get(/databases/$(database)/documents/users/$(getUserId())).data;
      return userData.role == 'admin' || 
             (userData.roles != null && 'admin' in userData.roles);
    }
    
    // Check if user is coach
    function isCoach() {
      return isAuthenticated() && (
        get(/databases/$(database)/documents/users/$(getUserId())).data.role == 'coach' || 
        (get(/databases/$(database)/documents/users/$(getUserId())).data.roles != null && 
         'coach' in get(/databases/$(database)/documents/users/$(getUserId())).data.roles)
      );
    }
    
    // Check if user is client
    function isClient() {
      return isAuthenticated() && (
        get(/databases/$(database)/documents/users/$(getUserId())).data.role == 'client' || 
        (get(/databases/$(database)/documents/users/$(getUserId())).data.roles != null && 
         'client' in get(/databases/$(database)/documents/users/$(getUserId())).data.roles)
      );
    }
    
    // Check if document belongs to coach (has coachId field matching user)
    function belongsToCoach() {
      return isAuthenticated() && 
             resource.data.coachId == getUserId();
    }
    
    // Check if document belongs to client (has clientId field matching user)
    function belongsToClient() {
      return isAuthenticated() && 
             resource.data.clientId == getUserId();
    }
    
    // Check if user owns their own profile
    function ownsProfile() {
      return isAuthenticated() && 
             request.resource.id == getUserId();
    }
    
    // ============================================
    // Users Collection
    // ============================================
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      // Coaches can read profiles of their clients
      allow read: if isAuthenticated() && (
        userId == getUserId() ||
        hasAdminRole() ||
        (isCoach() && exists(/databases/$(database)/documents/clients/$(userId)) && 
         get(/databases/$(database)/documents/clients/$(userId)).data.coachId == getUserId())
      );
      
      // Users can update their own profile (limited fields)
      // Admins can update any profile
      allow update: if isAuthenticated() && (
        userId == getUserId() ||
        hasAdminRole()
      );
      
      // Only admins can create/delete user profiles
      allow create, delete: if hasAdminRole();
    }
    
    // ============================================
    // Coaches Collection
    // ============================================
    match /coaches/{coachId} {
      // Coaches can read their own profile
      // Admins can read all coach profiles
      allow read: if isAuthenticated() && (
        coachId == getUserId() ||
        hasAdminRole()
      );
      
      // Coaches can update their own profile
      // Admins can update any coach profile
      allow update: if isAuthenticated() && (
        coachId == getUserId() ||
        hasAdminRole()
      );
      
      // Only admins can create/delete coach profiles
      allow create, delete: if hasAdminRole();
    }
    
    // ============================================
    // Clients Collection
    // ============================================
    match /clients/{clientId} {
      // Clients can read their own profile
      // Coaches can read profiles of their clients
      // Admins can read all client profiles
      allow read: if isAuthenticated() && (
        clientId == getUserId() ||
        resource.data.authUid == getUserId() ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Coaches can update profiles of their clients
      // Clients can update their own profile (limited fields)
      // Admins can update any client profile
      allow update: if isAuthenticated() && (
        (isCoach() && resource.data.coachId == getUserId()) ||
        (clientId == getUserId() || resource.data.authUid == getUserId()) ||
        hasAdminRole()
      );
      
      // Coaches can create clients (assigned to them)
      // Admins can create any client
      allow create: if isAuthenticated() && (
        (isCoach() && request.resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Only admins can delete clients
      allow delete: if hasAdminRole();
    }
    
    // ============================================
    // Forms Collection
    // ============================================
    match /forms/{formId} {
      // All authenticated users can read forms
      // (Forms are needed for check-ins and may be shared)
      // Coaches can read all forms (needed for assigning to clients)
      // Clients can read forms assigned to them (via check-in assignments)
      // Standard forms are readable by all authenticated users
      allow read: if isAuthenticated();
      
      // Coaches can create/update/delete their own forms
      // Admins can manage all forms
      allow create: if isAuthenticated() && (
        (isCoach() && request.resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      allow update, delete: if isAuthenticated() && (
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // Questions Collection
    // ============================================
    match /questions/{questionId} {
      // All authenticated users can read questions
      // (Questions are needed for check-in forms that clients need to fill out)
      // Coaches can read their own questions
      // Clients need to read questions to complete check-in forms
      // Admins can read all questions
      allow read: if isAuthenticated();
      
      // Coaches can create/update/delete their own questions
      // Admins can manage all questions
      allow write: if isAuthenticated() && (
        (isCoach() && (resource.data.coachId == getUserId() || 
                       request.resource.data.coachId == getUserId())) ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // Check-in Assignments Collection
    // ============================================
    match /check_in_assignments/{assignmentId} {
      // Clients can read their own assignments
      // clientId can be either the Firestore document ID or the authUid
      // Coaches can read assignments for their clients
      // Admins can read all assignments
      allow read: if isAuthenticated() && (
        (isClient() && (
          // Direct match (clientId equals authUid)
          resource.data.clientId == getUserId() ||
          // Or clientId is a document ID that belongs to this user
          (exists(/databases/$(database)/documents/clients/$(resource.data.clientId)) &&
           get(/databases/$(database)/documents/clients/$(resource.data.clientId)).data.authUid == getUserId())
        )) ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Coaches can create/update assignments for their clients
      // Admins can manage all assignments
      allow write: if isAuthenticated() && (
        (isCoach() && (resource.data.coachId == getUserId() || 
                       request.resource.data.coachId == getUserId())) ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // Form Responses Collection
    // ============================================
    match /formResponses/{responseId} {
      // Clients can read their own responses
      // Coaches can read responses for their clients
      // Admins can read all responses
      allow read: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Clients can create their own responses
      // Coaches can update responses (for feedback)
      // Admins can manage all responses
      allow create: if isAuthenticated() && (
        (isClient() && request.resource.data.clientId == getUserId()) ||
        hasAdminRole()
      );
      
      allow update: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Only admins can delete responses
      allow delete: if hasAdminRole();
    }
    
    // ============================================
    // Coach Feedback Collection
    // ============================================
    match /coachFeedback/{feedbackId} {
      // Clients can read feedback on their responses
      // Coaches can read their own feedback
      // Admins can read all feedback
      allow read: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Coaches can create/update feedback for their clients
      // Admins can manage all feedback
      allow write: if isAuthenticated() && (
        (isCoach() && (resource.data.coachId == getUserId() || 
                       request.resource.data.coachId == getUserId())) ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // Notifications Collection
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      // Admins can read all notifications
      allow read: if isAuthenticated() && (
        resource.data.userId == getUserId() ||
        hasAdminRole()
      );
      
      // System/admins can create notifications
      // Users can update their own notifications (mark as read)
      allow create: if isAuthenticated() && (
        request.resource.data.userId == getUserId() ||
        hasAdminRole()
      );
      
      allow update: if isAuthenticated() && (
        resource.data.userId == getUserId() ||
        hasAdminRole()
      );
      
      // Users can delete their own notifications
      // Admins can delete any notification
      allow delete: if isAuthenticated() && (
        resource.data.userId == getUserId() ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // Messages Collection
    // ============================================
    match /messages/{messageId} {
      // Clients can read messages in their conversations
      // Coaches can read messages in their conversations
      // Admins can read all messages
      allow read: if isAuthenticated() && (
        (isClient() && (resource.data.clientId == getUserId() || 
                        resource.data.toUserId == getUserId())) ||
        (isCoach() && (resource.data.coachId == getUserId() || 
                       resource.data.toUserId == getUserId())) ||
        hasAdminRole()
      );
      
      // Users can create messages in their conversations
      // Admins can create any message
      allow create: if isAuthenticated() && (
        (isClient() && (request.resource.data.clientId == getUserId() || 
                        request.resource.data.fromUserId == getUserId())) ||
        (isCoach() && (request.resource.data.coachId == getUserId() || 
                       request.resource.data.fromUserId == getUserId())) ||
        hasAdminRole()
      );
      
      // Only admins can update/delete messages
      allow update, delete: if hasAdminRole();
    }
    
    // ============================================
    // Client Scoring Collection
    // ============================================
    match /clientScoring/{scoringId} {
      // Clients can read their own scoring config
      // Coaches can read scoring for their clients (scoringId is the clientId)
      // Admins can read all scoring configs
      allow read: if isAuthenticated() && (
        (isClient() && scoringId == getUserId()) ||
        (isCoach() && 
         exists(/databases/$(database)/documents/clients/$(scoringId)) &&
         get(/databases/$(database)/documents/clients/$(scoringId)).data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Coaches can create/update scoring for their clients
      // Admins can manage all scoring configs
      allow write: if isAuthenticated() && (
        (isCoach() && 
         exists(/databases/$(database)/documents/clients/$(scoringId)) &&
         get(/databases/$(database)/documents/clients/$(scoringId)).data.coachId == getUserId()) ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // Client Measurements Collection
    // ============================================
    match /client_measurements/{measurementId} {
      // Clients can read their own measurements
      // Coaches can read measurements for their clients
      // Admins can read all measurements
      allow read: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.clientId != null &&
         exists(/databases/$(database)/documents/clients/$(resource.data.clientId)) &&
         get(/databases/$(database)/documents/clients/$(resource.data.clientId)).data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Clients can create their own measurements
      // Coaches can create measurements for their clients
      // Admins can create any measurement
      allow create: if isAuthenticated() && (
        (isClient() && request.resource.data.clientId == getUserId()) ||
        (isCoach() && request.resource.data.clientId != null &&
         exists(/databases/$(database)/documents/clients/$(request.resource.data.clientId)) &&
         get(/databases/$(database)/documents/clients/$(request.resource.data.clientId)).data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Users can update their own measurements
      // Coaches can update measurements for their clients
      // Admins can update any measurement
      allow update: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.clientId != null &&
         exists(/databases/$(database)/documents/clients/$(resource.data.clientId)) &&
         get(/databases/$(database)/documents/clients/$(resource.data.clientId)).data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Users can delete their own measurements
      // Admins can delete any measurement
      allow delete: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // Progress Images Collection
    // ============================================
    match /progress_images/{imageId} {
      // Clients can read their own progress images
      // Coaches can read progress images for their clients
      // Admins can read all progress images
      allow read: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Clients can create their own progress images
      // Coaches can create progress images for their clients
      // Admins can create any progress image
      allow create: if isAuthenticated() && (
        (isClient() && request.resource.data.clientId == getUserId()) ||
        (isCoach() && request.resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Users can update their own progress images
      // Coaches can update progress images for their clients
      // Admins can update any progress image
      allow update: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Users can delete their own progress images
      // Coaches can delete progress images for their clients
      // Admins can delete any progress image
      allow delete: if isAuthenticated() && (
        (isClient() && resource.data.clientId == getUserId()) ||
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
    }
    
    // ============================================
    // AI Analytics History Collection
    // ============================================
    match /ai_analytics_history/{historyId} {
      // Only coaches and admins can access AI analytics
      // Coaches can only access analytics for their own clients
      allow read: if isAuthenticated() && (
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Only server-side (via Admin SDK) should create/update
      // This rule prevents client-side writes
      allow write: if false; // Client-side writes disabled
    }
    
    // ============================================
    // Weekly Summaries Collection
    // ============================================
    match /weekly_summaries/{summaryId} {
      // Only coaches and admins can access weekly summaries
      // Coaches can only access summaries for their own clients
      allow read: if isAuthenticated() && (
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Only server-side (via Admin SDK) should create/update
      allow write: if false; // Client-side writes disabled
    }
    
    // ============================================
    // SWOT Analyses Collection
    // ============================================
    match /swot_analyses/{analysisId} {
      // Only coaches and admins can access SWOT analyses
      // Coaches can only access analyses for their own clients
      allow read: if isAuthenticated() && (
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Only server-side (via Admin SDK) should create/update
      allow write: if false; // Client-side writes disabled
    }
    
    // ============================================
    // Onboarding Reports Collection
    // ============================================
    match /onboarding_reports/{reportId} {
      // Coaches can read reports for their clients
      // Admins can read all reports
      allow read: if isAuthenticated() && (
        (isCoach() && resource.data.coachId == getUserId()) ||
        hasAdminRole()
      );
      
      // Only server-side (via Admin SDK) should create/update
      allow write: if false; // Client-side writes disabled
    }
    
    // ============================================
    // Default Deny
    // ============================================
    // Any collection not explicitly matched above will be denied
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
