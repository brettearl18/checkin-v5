rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user's UID
    function getUserId() {
      return request.auth.uid;
    }
    
    // ============================================
    // Progress Images
    // ============================================
    // Path: progress-images/{clientId}/{imageId}
    match /progress-images/{clientId}/{imageId} {
      // Clients can read their own progress images
      // Coaches can read progress images for their clients (via metadata)
      // Admins: Note - Storage rules don't support Firestore get() calls easily,
      // so admins would need to be handled server-side or we allow authenticated users
      // with proper metadata verification
      allow read: if isAuthenticated() && (
        // Client owns the image
        clientId == getUserId() ||
        // Coach can read if metadata indicates they're the coach
        (resource.metadata.coachId != null && resource.metadata.coachId == getUserId())
      );
      
      // Clients can upload their own progress images
      // Coaches can upload for their clients (via API - metadata will be set server-side)
      // Note: Uploads are typically done server-side via API routes, so this rule
      // provides additional client-side protection if needed
      allow write: if isAuthenticated() && (
        clientId == getUserId() ||
        // Allow if metadata indicates coach ownership (set by server)
        (request.resource.metadata.coachId != null && 
         request.resource.metadata.coachId == getUserId())
      );
      
      // Clients can delete their own images
      // Coaches can delete images for their clients
      allow delete: if isAuthenticated() && (
        clientId == getUserId() ||
        (resource.metadata.coachId != null && resource.metadata.coachId == getUserId())
      );
    }
    
    // ============================================
    // Profile Images/Photos
    // ============================================
    // Path: profile-images/{userId}/{photoId}
    // Note: Files may be made public for display, but rules protect write/delete
    match /profile-images/{userId}/{photoId} {
      // Any authenticated user can read profile images (for display in UI)
      // Users can write their own profile images
      // Users can delete their own profile images
      allow read: if isAuthenticated();
      
      allow write: if isAuthenticated() && userId == getUserId();
      
      allow delete: if isAuthenticated() && userId == getUserId();
    }
    
    // ============================================
    // Default Deny
    // ============================================
    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

      // Coaches can delete images for their clients
      allow delete: if isAuthenticated() && (
        clientId == getUserId() ||
        (resource.metadata.coachId != null && resource.metadata.coachId == getUserId())
      );
    }
    
    // ============================================
    // Profile Images/Photos
    // ============================================
    // Path: profile-images/{userId}/{photoId}
    // Note: Files may be made public for display, but rules protect write/delete
    match /profile-images/{userId}/{photoId} {
      // Any authenticated user can read profile images (for display in UI)
      // Users can write their own profile images
      // Users can delete their own profile images
      allow read: if isAuthenticated();
      
      allow write: if isAuthenticated() && userId == getUserId();
      
      allow delete: if isAuthenticated() && userId == getUserId();
    }
    
    // ============================================
    // Default Deny
    // ============================================
    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
