# Changes Since Last Deployment

**Date**: January 2025  
**Summary**: Security enhancements, UI improvements, and bug fixes

---

## üîê Security Enhancements

### 1. XSS Vulnerability Fix (CRITICAL)
- **File**: `src/app/clients/[id]/page.tsx`
- **Change**: Removed `dangerouslySetInnerHTML` usage
- **Impact**: Prevents cross-site scripting attacks
- **Status**: ‚úÖ Fixed and tested

### 2. Rate Limiting Implementation
- **Files**: 
  - `src/lib/rate-limit.ts` (new)
  - `src/middleware.ts` (new)
- **Change**: Implemented rate limiting for all API routes
- **Limits**:
  - Authentication endpoints: 5 requests/minute per IP
  - File upload endpoints: 10 requests/minute per IP
  - Admin endpoints: 10 requests/minute per IP
  - General API endpoints: 100 requests/minute per IP
- **Impact**: Prevents brute force attacks, DDoS, and API abuse
- **Status**: ‚úÖ Implemented

### 3. Error Message Information Leakage Fixes
- **Files**:
  - `src/app/api/admin/reorder-form-questions/route.ts`
  - `src/app/api/admin/check-form-questions/route.ts`
  - `src/app/api/client-portal/join-checkin/route.ts`
  - `src/app/api/client-portal/submit-issue/route.ts`
- **Change**: Added `NODE_ENV` guards to prevent error message leakage in production
- **Impact**: Prevents sensitive information exposure in error responses
- **Status**: ‚úÖ Fixed

### 4. File Upload Validation Enhancements
- **Files**:
  - `src/app/api/progress-images/upload/route.ts`
  - `src/app/api/client-portal/profile-image/route.ts`
- **Changes**:
  - Added 5MB file size limit validation
  - Added strict MIME type validation (JPEG, PNG, WebP, GIF only)
- **Impact**: Prevents malicious file uploads and storage abuse
- **Status**: ‚úÖ Enhanced

### 5. Security Audit Scripts
- **Files**:
  - `scripts/audit-api-auth.js` (new)
  - `scripts/audit-error-messages.js` (new)
- **Change**: Created automated security audit scripts
- **Impact**: Ongoing security verification capability
- **Status**: ‚úÖ Created

---

## üé® UI/UX Improvements

### 6. Goals Tab (Replaced Progress Tab)
- **File**: `src/app/clients/[id]/page.tsx`
- **Change**: 
  - Replaced "Progress" tab with "Goals" tab
  - Displays client goals in a clean, readable format
  - Removed Progress tab content (Question Progress Grid, Progress Images)
- **Impact**: Improved focus on client goals for coaches
- **Status**: ‚úÖ Implemented

### 7. Quick Review Table Enhancement
- **File**: `src/app/clients/[id]/page.tsx`
- **Change**: 
  - Replaced check-in name with percentage score in Quick Review table
  - Shows score (e.g., "75%") instead of form title
  - Maintains expand/collapse functionality
- **Impact**: Better at-a-glance check-in performance view
- **Status**: ‚úÖ Implemented

### 8. Onboarding Questionnaire Removal
- **File**: `src/app/clients/[id]/page.tsx`
- **Change**: Removed Onboarding Questionnaire section from Overview tab
- **Impact**: Cleaner overview, questionnaire accessible via quick menu
- **Status**: ‚úÖ Removed

---

## üìä New Features

### 9. Security Audit Documentation
- **Files**:
  - `SECURITY_AUDIT_JAN_2025.md` (new)
  - `API_AUTH_AUDIT_RESULTS.md` (new)
  - `ERROR_MESSAGE_AUDIT_REPORT.json` (new - generated by script)
- **Change**: Comprehensive security audit documentation
- **Impact**: Security best practices documented
- **Status**: ‚úÖ Created

---

## üîß Technical Changes

### 10. Rate Limiting Utility
- **File**: `src/lib/rate-limit.ts` (new, 144 lines)
- **Features**:
  - In-memory rate limiting store
  - Configurable limits per endpoint type
  - Automatic cleanup of expired entries
  - IP-based client identification

### 11. Next.js Middleware
- **File**: `src/middleware.ts` (new)
- **Features**:
  - Applies rate limiting to all API routes
  - Route-specific rate limit configurations
  - Standard rate limit headers (X-RateLimit-*)
  - HTTP 429 responses for exceeded limits

---

## üìù Files Modified

### Modified Files:
1. `src/app/clients/[id]/page.tsx` - Goals tab, Quick Review, Onboarding removal
2. `src/app/api/admin/reorder-form-questions/route.ts` - Error message fix
3. `src/app/api/admin/check-form-questions/route.ts` - Error message fix
4. `src/app/api/client-portal/join-checkin/route.ts` - Error message fix
5. `src/app/api/client-portal/submit-issue/route.ts` - Error message fix
6. `src/app/api/progress-images/upload/route.ts` - File upload validation
7. `src/app/api/client-portal/profile-image/route.ts` - File upload validation

### New Files:
1. `src/lib/rate-limit.ts` - Rate limiting utility
2. `src/middleware.ts` - Next.js middleware for rate limiting
3. `scripts/audit-api-auth.js` - API authentication audit script
4. `scripts/audit-error-messages.js` - Error message audit script
5. `SECURITY_AUDIT_JAN_2025.md` - Security audit report
6. `API_AUTH_AUDIT_RESULTS.md` - Authentication audit results
7. `CHANGES_SINCE_LAST_DEPLOYMENT.md` - This file

---

## üéØ Impact Summary

### Security
- ‚úÖ 1 critical vulnerability fixed (XSS)
- ‚úÖ Rate limiting implemented (prevents abuse)
- ‚úÖ Error message leakage prevented
- ‚úÖ File upload validation enhanced
- ‚úÖ Security audit tools created

### User Experience
- ‚úÖ Goals tab replaces Progress tab (better coach workflow)
- ‚úÖ Quick Review table shows scores instead of names
- ‚úÖ Cleaner Overview tab (removed redundant onboarding section)

### Code Quality
- ‚úÖ Security best practices implemented
- ‚úÖ Audit scripts for ongoing verification
- ‚úÖ Comprehensive security documentation

---

## ‚ö†Ô∏è Deployment Notes

1. **Rate Limiting**: Uses in-memory storage (works for single instance). For multi-instance deployments, consider Redis-based rate limiting.

2. **Security Scripts**: Audit scripts are for development use and can be run as needed.

3. **Build Status**: All changes tested and build passes successfully.

4. **Breaking Changes**: None - all changes are backward compatible.

---

## üöÄ Recommended Deployment Steps

1. Review and test changes on staging/localhost
2. Verify rate limiting doesn't interfere with normal usage
3. Test file uploads with new validation
4. Verify Goals tab displays correctly
5. Check Quick Review table functionality
6. Deploy to production

---

**Total Changes**: 
- 7 files modified
- 7 new files created
- 0 breaking changes
- 4 critical/high security improvements
- 3 UI/UX enhancements

